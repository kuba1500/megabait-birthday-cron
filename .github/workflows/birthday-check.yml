name: Daily Birthday Check

on:
  schedule:
    - cron: '30 8 * * *'
  workflow_dispatch:

jobs:
  check-birthdays:
    runs-on: ubuntu-latest
    
    steps:
      - name: Call Birthday Check Function
        env:
          BASE44_API_KEY: ${{ secrets.BASE44_API_KEY }}
        run: |
          echo "🎂 Starting birthday check..."
          echo "📍 Using API Key: ${BASE44_API_KEY:0:8}..." # Show first 8 chars only
          
          echo ""
          echo "📤 Sending request..."
          
          response=$(curl -v -X POST \
            -H "Content-Type: application/json" \
            -H "api_key: $BASE44_API_KEY" \
            -d '{}' \
            "https://megabaitprivate.base44.app/api/apps/68a20f7a1cd7c118dc55744d/functions/triggerBirthdayCheck?token=birthday-check-secret-2025-mega-bait" \
            2>&1)
          
          echo ""
          echo "📥 Full Response:"
          echo "$response"
          
          echo ""
          
          # Extract HTTP status code
          http_code=$(echo "$response" | grep "< HTTP" | tail -1 | awk '{print $3}')
          
          echo "Status Code: $http_code"
          
          if [ "$http_code" = "200" ]; then
            echo "✅ Birthday check completed successfully!"
          else
            echo "❌ Birthday check failed with status $http_code"
            exit 1
          fi
